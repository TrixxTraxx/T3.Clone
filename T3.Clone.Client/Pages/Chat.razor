@page "/"
@page "/chat"
@page "/chat/{ThreadId:int}"
@using T3.Clone.Client.Caches
@inject MessageSyncService MessageSyncService
@inject ISnackbar Snackbar
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

<script>
    window.setupChatInputAutoFocus = function (element) {
        if (!element) return;
        document.addEventListener('keydown', function (e) {
            // Only focus if not already in an input, textarea, or contenteditable, and not typing shortcuts
            const tag = document.activeElement.tagName;
            const editable = document.activeElement.isContentEditable;
            if (
                !e.ctrlKey && !e.metaKey && !e.altKey &&
                !editable &&
                tag !== 'INPUT' && tag !== 'TEXTAREA' && tag !== 'SELECT'
            ) {
                // Only focus on visible character keys (no function keys, etc)
                if (e.key.length === 1) {
                    element.focus();
                }
            }
        });
    };
</script>

<PageTitle>LLM Lab - AI Chat Assistant</PageTitle>

<div class="chat-container">
    <div class="chat-messages-container">
        @if (isLoading)
        {
            <div class="loading-container">
                <MudProgressCircular Indeterminate="true" Size="Size.Medium" />
                <MudText Typo="Typo.h6" Class="mt-4">Loading conversation...</MudText>
            </div>
        }
        else
        {
            <ChatTree
                Messages="currentBranch"
            />
        }
    </div>
    
    <ChatInput 
        @ref="ChatInput"
        OnSendMessage="HandleSendMessage" 
        OnAttachmentAdded="HandleAttachment"
        IsLoading="isSending" />
</div>

@code {
    [Parameter]
    public int? ThreadId { get; set; }

    public ChatInput ChatInput { get; set; }

    private MessageTreeDto? messageTree;
    private bool isLoading = false;
    private bool isSending = false;
    
    //the down most message of the current Branch
    private int currentBranchPath;
    private List<MessageCache> currentBranch = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadChat();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadChat();
    }

    private async Task LoadChat()
    {
        if (ThreadId.HasValue)
        {
            isLoading = true;
            StateHasChanged();

            try
            {
                messageTree = await MessageSyncService.GetMessageTree(ThreadId.Value);
                InitializeBranchPath();
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading chat: {ex.Message}");
                messageTree = null;
            }

            isLoading = false;
            StateHasChanged();
        }
        else
        {
            messageTree = null;
            currentBranch = new List<MessageCache>();
            currentBranchPath = 0;
            StateHasChanged();
        }
        _ = Task.Run(async () =>
        {
            await Task.Delay(50);
            await JSRuntime.InvokeVoidAsync("focusElement", ChatInput.textareaRef);
            await JSRuntime.InvokeVoidAsync("setupChatInputAutoFocus", ChatInput.textareaRef);
        }); 
    }

    private void InitializeBranchPath()
    {
        if (messageTree == null) return;

        currentBranchPath = messageTree.StartMessageId;
        
        // Build the path from start to end
        currentBranch = messageTree.GetMessagesForBranch(currentBranchPath);
    }

    private async Task HandleSendMessage(MessageDto message)
    {
        if (string.IsNullOrWhiteSpace(message.Text)) return;

        isSending = true;
        StateHasChanged();
        
        message.ThreadId = ThreadId ?? 0;
        message.PreviousMessageId = currentBranchPath;
        
        try
        {
            // Add user message to display
            var messageCache = new MessageCache
            {
                Message = message
            };
            currentBranch.Insert(0, messageCache);
            StateHasChanged();

            var result = await MessageSyncService.SendMessage(messageCache);
            messageCache.Message = result;
            ThreadId = result.ThreadId;
            currentBranchPath = result.Id;
            
            //set the current location to the message
            //await JSRuntime.InvokeVoidAsync("setHistory", "/chat/" + result.ThreadId);
            NavigationManager.NavigateTo("/chat/" + result.ThreadId, replace: true);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error sending message: {ex.Message}");
        }

        isSending = false;
        StateHasChanged();
    }

    private void HandleAttachment(ChatAttachment attachment)
    {
        // Handle attachment processing
        Console.WriteLine($"Attachment added: {attachment.Name}");
    }

    private async Task RegenerateMessage(int messageId)
    {
        // TODO: Implement message regeneration
        Console.WriteLine($"Regenerating message: {messageId}");
    }
} 